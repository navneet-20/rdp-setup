name: "On-Demand Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: üöÄ Start Portal & Display Links
        run: |
          # 1. Clone PairDrop
          git clone https://github.com .
          
          # 2. Install Tools (tmate & cloudflared)
          sudo apt-get update && sudo apt-get install -y tmate
          curl -L https://github.com -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
          
          # 3. Install & Start PairDrop
          export NODE_ENV=production
          export CI=true
          npm install
          npm start & 
          
          # 4. Start Tunnels
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &
          
          # 5. Start tmate (Fixed: No more wait-for-session-initialized)
          tmate -S /tmp/tmate.sock new-session -d
          
          # 6. Display Credentials
          echo "========================================================="
          echo "‚è≥ Generating your public link (Wait 20s)..."
          sleep 20
          echo ""
          echo "üåê WEB INTERFACE (ToffeeShare style):"
          # Try to extract the link, if not found, show the log
          if grep -q "trycloudflare.com" cloudflare.log; then
            grep -o 'https://.*\.trycloudflare\.com' cloudflare.log | head -n 1
          else
            echo "‚ùå Link not found yet. Full Tunnel Log:"
            cat cloudflare.log
          fi
          echo ""
          echo "üíª SSH ACCESS (Management):"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "========================================================="
          
          # Keep the runner alive
          echo "‚úÖ Server is LIVE. Close this tab or cancel the run to stop."
          sleep 21600
