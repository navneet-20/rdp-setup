name: "On-Demand Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: üöÄ Start Portal
        run: |
          # 1. Setup Environment
          git clone https://github.com .
          sudo apt-get update && sudo apt-get install -y tmate
          curl -L https://github.com -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
          
          # 2. Start PairDrop (Background)
          npm install
          npm start & 
          
          # 3. Start Tunnels (Background)
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &
          tmate -S /tmp/tmate.sock new-session -d
          
          # 4. Display Links and Wait
          echo "========================================================="
          echo "‚è≥ Generating your public link (Wait 20s)..."
          sleep 20
          echo ""
          echo "üåê WEB INTERFACE (ToffeeShare style):"
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log || echo "‚ùå Link not found yet. Check logs."
          echo ""
          echo "üíª SSH ACCESS:"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "========================================================="
          
          # 5. KEEP ALIVE - This prevents the 'Exit Code 1'
          echo "‚úÖ Portal is live. Use the link above."
          # This loop keeps the script running so GitHub doesn't kill the background tasks
          tail -f /dev/null
