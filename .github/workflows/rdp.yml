name: "Temp Share Server"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget

      - name: Install transfer-server
        run: |
          wget https://github.com/dutchcoders/transfer.sh/releases/latest/download/transfer-server_linux_amd64.tar.gz
          tar -xzf transfer-server_linux_amd64.tar.gz
          chmod +x transfer-server

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb

      - name: Start file server + tunnel
        run: |
          mkdir uploads

          # start transfer.sh server
          ./transfer-server \
            --provider local \
            --temp-path uploads \
            --port 8080 > server.log 2>&1 &

          sleep 10

          # start cloudflare tunnel
          cloudflared tunnel --url http://localhost:8080 > cloudflare.log 2>&1 &

          sleep 20

          echo "===================================="
          echo "ðŸ“¤ OPEN THIS LINK TO UPLOAD FILE:"
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log | head -n 1
          echo "===================================="

          # keep runner alive
          sleep 21600
