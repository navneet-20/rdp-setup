name: "On-Demand Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: üöÄ Start Portal & Display Links
        run: |
          # 1. Clone the correct PairDrop repository
          git clone https://github.com/schlagmichdoch/PairDrop.git .
          
          # 2. Setup Management (tmate)
          sudo apt-get update && sudo apt-get install -y tmate
          
          # 3. Install latest cloudflared (Verified x64 link)
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
          
          # 4. Install PairDrop Dependencies and Start Server
          # PairDrop default port is 3000
          npm install
          npm start & 
          
          # 5. Start Tunnels in Background
          # We use --logfile to ensure the URL is captured correctly
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &
          
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait-for-session-initialized
          
          # 6. Display Credentials
          echo "========================================================="
          echo "‚è≥ Generating your public link (Wait 15s)..."
          sleep 15
          echo ""
          echo "üåê WEB INTERFACE (ToffeeShare style):"
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log || (echo "‚ùå Link failed. Showing log tail:" && tail -n 10 cloudflare.log)
          echo ""
          echo "üíª SSH ACCESS (Management):"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "========================================================="
          
          # Keep the runner alive
          echo "‚úÖ Server is LIVE. Close this tab or cancel the run to stop."
          sleep 21600
