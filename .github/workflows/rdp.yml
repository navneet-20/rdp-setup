name: On-Demand PairDrop Share

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: Checkout PairDrop
        uses: actions/checkout@v4
        with:
          repository: 'schlagmichdoch/PairDrop'

      - name: Install & Start PairDrop
        run: |
          npm install
          npm start & # Runs web server on port 3000

      - name: Setup Tunnels (Web + SSH)
        run: |
          # 1. Install Cloudflare for the Web UI
          wget https://github.com
          sudo dpkg -i cloudflared.deb
          
          # 2. Start Cloudflare Tunnel in background
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &
          
          # 3. Start tmate (SSH) for your management
          sudo apt-get install -y tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait-for-session-initialized
          
          echo "================================================"
          echo "üåê WEB INTERFACE (ToffeeShare style):"
          sleep 5 # Wait for tunnel to generate link
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log
          echo ""
          echo "üíª SSH ACCESS (Management):"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "================================================"

      - name: Keep Alive (6 Hours)
        run: sleep 21600
