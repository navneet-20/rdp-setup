name: "On-Demand Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: üöÄ Start Portal & Display Links
        run: |
          # 1. Clone PairDrop
          git clone https://github.com .
          
          # 2. Install Tools (tmate & cloudflared)
          sudo apt-get update && sudo apt-get install -y tmate
          curl -L https://github.com -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
          
          # 3. Fix: PairDrop requires these env vars to run properly in a restricted environment
          export NODE_ENV=production
          
          # 4. Install & Start PairDrop
          npm install
          npm start & 
          
          # 5. Start Tunnels
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &
          
          # 6. Start tmate (Fixed syntax)
          tmate -S /tmp/tmate.sock new-session -d
          # Wait for tmate to initialize manually instead of using the broken command
          until [ -S /tmp/tmate.sock ]; do sleep 1; done
          
          # 7. Display Credentials
          echo "========================================================="
          echo "‚è≥ Generating your public link (Wait 15s)..."
          sleep 15
          echo ""
          echo "üåê WEB INTERFACE (ToffeeShare style):"
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log || (echo "‚ùå Link failed. Log excerpt:" && tail -n 15 cloudflare.log)
          echo ""
          echo "üíª SSH ACCESS (Management):"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "========================================================="
          
          # Keep the runner alive
          echo "‚úÖ Server is LIVE. Close this tab or cancel the run to stop."
          sleep 21600
