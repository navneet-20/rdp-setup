name: "On-Demand Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: Setup Environment
        run: |
          # Checkout PairDrop
          git clone https://github.com .
          
          # Install Node & Cloudflared
          sudo apt-get update && sudo apt-get install -y tmate
          curl -L https://github.com -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
          
          # Install & Start PairDrop
          npm install
          npm start & 

      - name: üöÄ START PORTAL & DISPLAY LINKS
        run: |
          # 1. Start Tunnel
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &
          
          # 2. Start tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait-for-session-initialized
          
          # 3. Wait and Print Links
          echo "========================================================="
          echo "‚è≥ Generating your public link (Wait 15s)..."
          sleep 15
          echo ""
          echo "üåê WEB INTERFACE (ToffeeShare style):"
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log || echo "‚ùå Link failed to generate. Check logs below."
          echo ""
          echo "üíª SSH ACCESS (Management):"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo "========================================================="
          
          # Keep the job running for 6 hours
          echo "‚úÖ Server is LIVE. Keep this tab open."
          sleep 21600
