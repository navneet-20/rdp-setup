name: "Pingvin Temporary Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io curl

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb

      - name: Start Pingvin Share
        run: |
          docker run -d \
            -p 3000:3000 \
            --name pingvin \
            ghcr.io/stonith404/pingvin-share:latest

          # wait for server
          sleep 15

          # start Cloudflare tunnel
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &

          sleep 20

          echo "======================================"
          echo "üåê OPEN THIS LINK:"
          grep -o 'https://.*\.trycloudflare\.com' cloudflare.log | head -n 1
          echo "======================================"

          # keep runner alive (~6 hours)
          sleep 21600
