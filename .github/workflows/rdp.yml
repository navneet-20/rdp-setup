name: "On-Demand Share"

on:
  workflow_dispatch:

jobs:
  share:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # GitHub max safe time

    steps:
      - name: üöÄ Start Portal & Display Links
        run: |
          echo "==== Setting up PairDrop server ===="

          # 1Ô∏è‚É£ Clone PairDrop repository
          git clone https://github.com/schlagmichdoch/PairDrop.git
          cd PairDrop

          # 2Ô∏è‚É£ Install dependencies
          sudo apt-get update
          sudo apt-get install -y tmate curl

          # 3Ô∏è‚É£ Install cloudflared correctly
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb

          # 4Ô∏è‚É£ Install Node packages & start PairDrop
          export NODE_ENV=production
          npm install
          npm start > server.log 2>&1 &

          # Wait for server to boot
          sleep 15

          # 5Ô∏è‚É£ Start Cloudflare tunnel
          cloudflared tunnel --url http://localhost:3000 > cloudflare.log 2>&1 &

          # Wait for tunnel link generation
          sleep 20

          echo ""
          echo "========================================================="
          echo "üåê PUBLIC FILE-SHARE LINK:"
          
          if grep -q "trycloudflare.com" cloudflare.log; then
            grep -o 'https://.*\.trycloudflare\.com' cloudflare.log | head -n 1
          else
            echo "‚ùå Tunnel link not ready yet. Showing log:"
            cat cloudflare.log
          fi

          echo ""
          echo "üíª OPTIONAL SSH ACCESS (tmate):"

          # 6Ô∏è‚É£ Start tmate session
          tmate -S /tmp/tmate.sock new-session -d
          sleep 5
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'

          echo "========================================================="
          echo "‚úÖ Server is LIVE for this workflow duration."
          echo "Cancel the run to stop."

          # 7Ô∏è‚É£ Keep runner alive (~6 hours max allowed)
          sleep 21600
